openapi: 3.0.1
info:
  description: Ledger API
  title: Ledger API
  version: v1.0.0
servers:
- url: http://ledger_url 
paths:
  /healthcheck:
    get:
      operationId: healthCheck
      responses:
        "200":
          content:
            application/json:
              schema:
                type: string
                example:
                  postgresql:
                    healthy: true
                    message: Healthy
                  sqsQueue:
                    healthy: true
                    message: Healthy
                  deadlocks:
                    healthy: true
                    message: Healthy
          description: OK
        "503":
          description: Service Unavailable
      summary: "Healthcheck endpoint the ledger (checks postgresql, sqs queue)"
      tags:
      - Other
  /v1/event/ticker:
    get:
      operationId: listEvents
      parameters:
      - description: from date of events to be searched (this date is inclusive).
        example: 2015-08-14T12:35:00Z
        in: query
        name: from_date
        required: true
        schema:
          type: string
      - description: to date of events to be searched (this date is exclusive)
        example: 2015-08-14T12:35:00Z
        in: query
        name: to_date
        required: true
        schema:
          type: string
      responses:
        "200":
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EventTicker'
          description: OK
        "422":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Missing query parameters
        "500":
          description: Invalid parameters or Downstream system error
      summary: Get list of events between a date/time range
      tags:
      - Events
  /v1/event/{eventId}:
    get:
      operationId: getEvent
      parameters:
      - in: path
        name: eventId
        required: true
        schema:
          type: integer
          format: int64
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
          description: OK
        "404":
          description: Not found
      summary: Find event by ID (id of event table)
      tags:
      - Events
  /v1/payout:
    get:
      operationId: search
      parameters:
      - description: "State of payout. allowed values are intransit, paidout, failed"
        in: query
        name: state
        schema:
          type: string
      - description: "Page number requested for the search, should be a positive integer\
          \ (optional, defaults to 1)"
        in: query
        name: page
        schema:
          type: integer
          format: int64
      - description: "Number of results to be shown per page, should be a positive\
          \ integer (optional, defaults to 500, max 500)"
        in: query
        name: display_size
        schema:
          type: integer
          format: int64
      - description: Set to true to list all payouts.
        in: query
        name: override_account_id_restriction
        schema:
          type: boolean
      - description: Comma separate gateway account IDs. Required except when override_account_id_restriction=true
        example: "1,2"
        in: query
        name: gateway_account_id
        required: true
        schema:
          type: string
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PayoutSearchResponse'
          description: OK
        "404":
          description: Not found
      summary: Search payouts by gateway_account_id and state
      tags:
      - Payouts
  /v1/report/gateway-performance-report:
    get:
      operationId: getGatewayMonthlyPerformanceReport
      parameters:
      - description: From date of transaction summary to be searched (this date is
          inclusive).
        example: 2022-03-29
        in: query
        name: from_date
        required: true
        schema:
          type: string
      - description: To date of transaction summary to be searched (this date is inclusive).
        example: 2022-03-29
        in: query
        name: to_date
        required: true
        schema:
          type: string
      responses:
        "200":
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GatewayAccountMonthlyPerformanceReportEntity'
          description: OK
        "400":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Missing required query parameters (from_date or to_date)
        "500":
          description: Internal Server Error for invalid query parameter values
      summary: Get monthly performance report by gateway account. Queries transaction_summary
        table
      tags:
      - Reports
  /v1/report/payments_by_state:
    get:
      operationId: getPaymentCountsByState
      parameters:
      - description: Gateway account ID. Required when override_account_id_restriction
          is 'false'
        example: 1
        in: query
        name: account_id
        schema:
          type: string
      - description: Set to true to return statistics for moto transactions
        example: false
        in: query
        name: include_moto_statistics
        schema:
          type: boolean
      - description: From date of transactions to be searched (this date is exclusive).
        example: 2022-03-29T00:00:00Z
        in: query
        name: from_date
        schema:
          type: string
      - description: To date of transactions to be searched (this date is exclusive).
        example: 2022-03-29T00:00:00Z
        in: query
        name: to_date
        schema:
          type: string
      - description: Set to true to get counts for all gateway accounts.
        in: query
        name: override_account_id_restriction
        schema:
          type: boolean
      responses:
        "200":
          content:
            application/json:
              schema:
                type: object
                example:
                  timedout: 0
                  submitted: 0
                  declined: 0
                  created: 0
                  success: 1
                  cancelled: 0
                  started: 0
                  error: 0
                  undefined: 0
                  capturable: 0
          description: OK
        "422":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Missing required or invalid query parameters (from_date or
            to_date)
      summary: Get number of payments by transaction (payment) state
      tags:
      - Reports
  /v1/report/performance-report:
    get:
      operationId: getPerformanceReport
      parameters:
      - description: From date of the transaction summary to be searched (this date
          is inclusive). Required when to_date is provided
        example: 2022-03-29
        in: query
        name: from_date
        schema:
          type: string
      - description: To date of the transaction summary to be searched (this date
          is inclusive). Required when from_date is provided
        example: 2022-03-29
        in: query
        name: to_date
        schema:
          type: string
      - description: Transaction state
        in: query
        name: state
        schema:
          type: string
          enum:
          - UNDEFINED
          - CREATED
          - STARTED
          - SUBMITTED
          - CAPTURABLE
          - SUCCESS
          - FAILED_REJECTED
          - FAILED_EXPIRED
          - FAILED_CANCELLED
          - CANCELLED
          - ERROR
          - ERROR_GATEWAY
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceReportEntity'
          description: OK
        "400":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: For missing query params or invalid state).
        "500":
          description: Internal Server Error for invalid query params (from_date/to_date)
            values
      summary: Get platform performance report (total volume and total_amount) for
        the date range and transaction state. Queries transaction_summary table for
        stats
      tags:
      - Reports
  /v1/report/performance-report-legacy:
    get:
      operationId: getLegacyPerformanceReport
      parameters:
      - description: From date of transactions to be searched (this date is inclusive).
        example: 2022-03-29T01:00:00Z
        in: query
        name: from_date
        schema:
          type: string
      - description: To date of transactions to be searched (this date is exclusive).
        example: 2022-03-29T01:00:00Z
        in: query
        name: to_date
        schema:
          type: string
      - description: Transaction state
        in: query
        name: state
        schema:
          type: string
          enum:
          - UNDEFINED
          - CREATED
          - STARTED
          - SUBMITTED
          - CAPTURABLE
          - SUCCESS
          - FAILED_REJECTED
          - FAILED_EXPIRED
          - FAILED_CANCELLED
          - CANCELLED
          - ERROR
          - ERROR_GATEWAY
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceReportEntity'
          description: OK
        "500":
          description: Internal Server Error for invalid query parameter values
      summary: "Get platform performance report (total volume and total_amount) for\
        \ the date range and transaction state. Queries transaction table for stats,\
        \ so could be slow for large date ranges"
      tags:
      - Reports
  /v1/report/transactions-by-hour:
    get:
      operationId: getTransactionsByHour
      parameters:
      - description: From date of transaction summary to be searched (this date is
          inclusive).
        example: 2022-03-29T00:00:00Z
        in: query
        name: from_date
        required: true
        schema:
          type: string
      - description: To date of transaction summary to be searched (this date is inclusive).
        example: 2022-03-29T00:00:00Z
        in: query
        name: to_date
        required: true
        schema:
          type: string
      responses:
        "200":
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TimeseriesReportSlice'
          description: OK
        "400":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Missing required query parameters
        "500":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Invalid query parameters (from_date or to_date)
      summary: Get transaction summary by hour
      tags:
      - Reports
  /v1/report/transactions-summary:
    get:
      operationId: getTransactionSummaryResult
      parameters:
      - description: Gateway account ID. Required when override_account_id_restriction
          is 'false'
        example: 1
        in: query
        name: account_id
        schema:
          type: string
      - description: Set to true to return statistics for moto transactions
        example: false
        in: query
        name: include_moto_statistics
        schema:
          type: boolean
      - description: From date of transactions to be searched (this date is exclusive).
        example: 2022-03-29T00:00:00Z
        in: query
        name: from_date
        schema:
          type: string
      - description: To date of transactions to be searched (this date is exclusive).
        example: 2022-03-29T00:00:00Z
        in: query
        name: to_date
        schema:
          type: string
      - description: Set to true to return summary for all accounts.
        in: query
        name: override_account_id_restriction
        schema:
          type: boolean
      - description: Set to true to make from_date non-mandatory.
        in: query
        name: override_from_date_validation
        schema:
          type: boolean
          default: false
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionSummaryResult'
          description: OK
        "400":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Missing required query parameter (from_date)
        "422":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
          description: Missing required or invalid query parameters (from_date or
            to_date)
      summary: Get transaction summary for query params
      tags:
      - Reports
components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        error_identifier:
          type: string
          enum:
          - GENERIC
          - REFUND_NOT_AVAILABLE
          - REFUND_AMOUNT_AVAILABLE_MISMATCH
          - ZERO_AMOUNT_NOT_ALLOWED
          - MOTO_NOT_ALLOWED
          - CANCEL_CHARGE_FAILURE_DUE_TO_CONFLICTING_TERMINAL_STATE_AT_GATEWAY_CHARGE_STATE_FORCIBLY_TRANSITIONED
          - CANCEL_CHARGE_FAILURE_DUE_TO_CONFLICTING_TERMINAL_STATE_AT_GATEWAY_INVALID_STATE_TRANSITION
          - AUTH_TOKEN_INVALID
          - AUTH_TOKEN_REVOKED
          - ACCOUNT_NOT_LINKED_WITH_PSP
          - TELEPHONE_PAYMENT_NOTIFICATIONS_NOT_ALLOWED
          - AGREEMENT_NOT_FOUND
          example: GENERIC
        message:
          type: array
          items:
            type: string
            example: example error message
    Event:
      type: object
      properties:
        event_data:
          type: string
          example: "{\"live\": false, \"moto\": false, \"amount\": 1000, \"source\"\
            : \"CARD_API\", \"language\": \"en\", \"reference\": \"my payment reference\"\
            , \"return_url\": \"https://www.payments.service.gov.uk\", \"description\"\
            : \"my payment\", \"delayed_capture\": false, \"payment_provider\": \"\
            sandbox\", \"gateway_account_id\": \"3\", \"credential_external_id\":\
            \ \"ddb294481de146c09598c8cce0461af9\", \"save_payment_instrument_to_agreement\"\
            : false}\""
        event_date:
          type: string
          format: date-time
        event_type:
          type: string
          example: PAYMENT_CREATED
        live:
          type: boolean
          example: true
        parent_resource_external_id:
          type: string
          default: "null"
          example: l40ajdf0923uojlkfjsldkjfl2
        reproject_domain_object:
          type: boolean
          default: false
          example: true
        resource_external_id:
          type: string
          example: 58na2dr7rv7h6h53bef1l0soep
        resource_type:
          type: string
          enum:
          - agreement
          - payment
          - refund
          - service
          - card_payment
          - payout
          - dispute
          example: payment
        service_id:
          type: string
          example: ea2d6673b23d4ff7ad88a1fd3c7ab0f6
        sqs_message_id:
          type: string
          example: fe689579-63af-40bf-a783-23de97134b5f
    EventTicker:
      type: object
      properties:
        amount:
          type: integer
          format: int64
          example: 100
        card_brand:
          type: string
          example: visa
        event_date:
          type: string
          format: date-time
        event_type:
          type: string
          example: PAYMENT_CREATED
        gateway_account_id:
          type: string
          example: "1"
        payment_provider:
          type: string
          example: sandbox
        resource_external_id:
          type: string
          example: 9np5pocnotgkpp029d5kdfau5f
        resource_type:
          type: string
          enum:
          - agreement
          - payment
          - refund
          - service
          - card_payment
          - payout
          - dispute
          example: payment
        transaction_type:
          type: string
          example: PAYMENT
    GatewayAccountMonthlyPerformanceReportEntity:
      type: object
      properties:
        average_amount:
          type: number
          example: 1000.0
        gateway_account_id:
          type: integer
          format: int64
          example: 1
        month:
          type: integer
          format: int64
          example: 3
        total_amount:
          type: number
          example: 1000
        total_volume:
          type: integer
          format: int64
          example: 1
        year:
          type: integer
          format: int64
          example: 2022
    PaginationBuilder:
      type: object
      properties:
        first_page:
          $ref: '#/components/schemas/PaginationLink'
        last_page:
          $ref: '#/components/schemas/PaginationLink'
        next_page:
          $ref: '#/components/schemas/PaginationLink'
        prev_page:
          $ref: '#/components/schemas/PaginationLink'
        self:
          $ref: '#/components/schemas/PaginationLink'
    PaginationLink:
      type: object
      properties:
        href:
          type: string
          example: https://an.example.link
    PayoutSearchResponse:
      type: object
      properties:
        _links:
          $ref: '#/components/schemas/PaginationBuilder'
        count:
          type: integer
          format: int64
          example: 100
        page:
          type: integer
          format: int64
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/PayoutView'
        total:
          type: integer
          format: int64
          example: 1000
    PayoutView:
      type: object
      properties:
        amount:
          type: integer
          format: int64
          description: amount in pence
          example: 1000
        created_date:
          type: string
          format: date-time
        gateway_account_id:
          type: string
          example: "1"
        gateway_payout_id:
          type: string
          example: po_sd0fkpam0dlwe10dmlsl3mf
        live:
          type: boolean
          example: true
        paid_out_date:
          type: string
          format: date-time
        service_id:
          type: string
          example: dlsd0dkad20sk0adne9fjd
        state:
          type: string
          enum:
          - UNDEFINED
          - IN_TRANSIT
          - PAID_OUT
          - FAILED
          example: "{\"status\":\"paidout\",\"finished\":true}"
    PerformanceReportEntity:
      type: object
      properties:
        average_amount:
          type: number
          example: 1000.0
        total_amount:
          type: number
          example: 1000
        total_volume:
          type: integer
          format: int64
          example: 1
    TimeseriesReportSlice:
      type: object
      properties:
        all_payments:
          type: integer
          format: int32
          example: 10
        amount:
          type: integer
          format: int32
          example: 70
        completed_payments:
          type: integer
          format: int32
          example: 7
        errored_payments:
          type: integer
          format: int32
          example: 3
        fee:
          type: integer
          format: int32
        net_amount:
          type: integer
          format: int32
        timestamp:
          type: string
          format: date-time
        total_amount:
          type: integer
          format: int32
    TransactionSummaryResult:
      type: object
      properties:
        moto_payments:
          $ref: '#/components/schemas/TransactionsStatisticsResult'
        net_income:
          type: integer
          format: int64
          example: 6000
        payments:
          $ref: '#/components/schemas/TransactionsStatisticsResult'
        refunds:
          $ref: '#/components/schemas/TransactionsStatisticsResult'
    TransactionsStatisticsResult:
      type: object
      properties:
        count:
          type: integer
          format: int64
          example: 1
        gross_amount:
          type: integer
          format: int64
          example: 2000
